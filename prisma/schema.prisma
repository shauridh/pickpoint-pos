generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

enum PackageStatus {
  PENDING_PICKUP
  PAID
  COMPLETED
  RETURNED
}

enum PaymentStatus {
  UNPAID
  PAID
}

enum PricingScheme {
  FLAT
  FLAT_SIZE
  PROGRESSIVE_DAY
  PROGRESSIVE_PACKAGE
}

enum PackageSize {
  S
  M
  L
  XL
}

enum PenaltyMode {
  FIRST_PACKAGE
  ADDITIONAL_PACKAGE
}

enum TransactionType {
  PACKAGE_FEE
  MEMBERSHIP_BUY
}

enum TransactionStatus {
  PENDING
  PAID
  FAILED
}

model User {
  id               String        @id @default(uuid())
  username         String?       @unique
  name             String
  phone            String        @unique
  unit             String?
  apartmentName    String?
  pin              String?
  pushSubscription Json?
  isMember         Boolean       @default(false)
  memberExpiryDate DateTime?
  role             Role          @default(CUSTOMER)
  locationId       Int?
  location         Location?     @relation("UserLocation", fields: [locationId], references: [id])
  isActive         Boolean       @default(true)
  packages         Package[]
  transactions     Transaction[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model MembershipPlan {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  price          Decimal          @db.Decimal(12, 2)
  durationInDays Int
  description    String?
  transactions   Transaction[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model Location {
  id                   Int            @id @default(autoincrement())
  name                 String         @unique
  dropSlug             String         @unique // Auto-generated slug for drop portal link
  price                Decimal        @db.Decimal(12, 2) // Legacy field for backward compatibility
  pricingScheme        PricingScheme  @default(FLAT)
  gracePeriodDays      Int            @default(0) // 0=berbayar hari kedatangan, 1=setelah 1 hari, dst
  priceConfig          Json           // Dynamic pricing configuration based on scheme
  deliveryEnabled      Boolean        @default(false)
  deliveryPriceConfig  Json?          // Size-based delivery prices: {S: 5000, M: 7000, L: 10000, XL: 15000}
  isActive             Boolean        @default(true)
  packages             Package[]
  staffUsers           User[]         @relation("UserLocation")
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}

model Package {
  id              String         @id @default(uuid())
  receiptNumber   String         @unique
  courierName     String
  size            PackageSize?   // Size determined during drop
  userId          String
  user            User           @relation(fields: [userId], references: [id])
  locationId      Int
  location        Location       @relation(fields: [locationId], references: [id])
  status          PackageStatus  @default(PENDING_PICKUP)
  proofPhotoUrl   String
  basePrice       Decimal        @db.Decimal(12, 2)
  penaltyFee      Decimal        @default(0) @db.Decimal(12, 2)
  deliveryFee     Decimal        @default(0) @db.Decimal(12, 2)
  needsDelivery   Boolean        @default(false) // Customer chooses during payment
  paymentStatus   PaymentStatus  @default(UNPAID)
  transactions    Transaction[]  @relation("PackageTransactions")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([locationId])
}

model Transaction {
  id               String             @id @default(uuid())
  userId           String
  user             User               @relation(fields: [userId], references: [id])
  type             TransactionType
  amount           Decimal            @db.Decimal(12, 2)
  snapToken        String?
  status           TransactionStatus  @default(PENDING)
  relatedPackageId String?
  relatedPackage   Package?           @relation("PackageTransactions", fields: [relatedPackageId], references: [id])
  relatedPlanId    Int?
  relatedPlan      MembershipPlan?    @relation(fields: [relatedPlanId], references: [id])
  createdAt        DateTime           @default(now())

  @@index([userId])
  @@index([relatedPackageId])
  @@index([relatedPlanId])
}
